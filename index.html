<!DOCTYPE html>

<html dir="rtl" lang="ar">
<head>
    <link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#2e4057">
    
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Ø¥Ø¯Ø§Ø±Ø© Ø³Ø§ÙŠØ¨Ø± ÙƒØ§ÙÙŠÙ‡</title>
<style>
/* Multiplayer button styling */
.multiplayer-btn {
    background-color: #9c27b0; /* Purple */
    color: white;
    width: 36px; /* Square shape */
    height: 36px;
    padding: 0;
    font-size: 18px;
    line-height: 36px; /* Center icon vertically */
    text-align: center;
    border: none; /* Added */
    border-radius: 5px; /* Added */
    cursor: pointer; /* Added */
    transition: background-color 0.3s; /* Added */
}

.multiplayer-btn:hover {
    background-color: #7b1fa2; /* Darker purple */
}

.multiplayer-btn.active {
    background-color: #ab47bc; /* Lighter purple */
    box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
}

.multiplayer-btn:disabled {
    background-color: #e0e0e0;
    cursor: not-allowed;
}
.multiplayer-btn.active {
  background-color: #28a745 !important;  /* Ø£Ø®Ø¶Ø± */
  color: white;
  border: none;
}

    </style>
<style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
       

    </style>
    
    <link rel="stylesheet" href="themes.css">
<script src="themeSwitcher.js" defer></script>
    
    
</head>
<body>
   
    
<div class="page-logo">
  <img src="logo.svg" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…ÙˆÙ‚Ø¹">
  <div class="logo-text">
    <h2>Youssef Hammad</h2>
    <p>Developer Zack</p>
  </div>
</div>



<div class="login-container" id="login-page">
<h1>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
<form id="login-form">
<div class="form-group">
<input id="username" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" required="" type="text"/>
</div>
<div class="form-group">
<input id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required="" type="password"/>
</div>
<button class="btn" type="submit">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
</form>
</div>

<div class="container" id="app" style="display: none;">
<div class="header">
  <div class="header-left">
    <h1>Ø¥Ø¯Ø§Ø±Ø© Ø³Ø§ÙŠØ¨Ø± ÙƒØ§ÙÙŠÙ‡</h1>
    <div class="nav-links">
      <a class="nav-link active" data-page="dashboard" href="#">Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</a>
      
        <a class="nav-link" data-page="report" href="#">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</a>
      <a class="nav-link" data-page="settings" href="#">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</a>
      <a class="nav-link" href="#" id="logout-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</a>
    </div>
  </div>
  <img src="logo.svg" alt="Ù„ÙˆØ¬Ùˆ" class="logo">
</div>


<div class="dashboard-page active-page" id="dashboard-page">
<div class="section-title">
<h2>Ø£Ø¬Ù‡Ø²Ø© Ø¨Ù„Ø§ÙŠØ³ØªÙŠØ´Ù† 5</h2>
</div>
<div class="dashboard" id="ps5-devices">
<div class="device-box" data-id="ps5-1">
<button class="delete-btn" title="Ø­Ø°Ù">Ã—</button>
<h3>
                        Ø¬Ù‡Ø§Ø² PS5 (1)
                        <span class="status available">Ù…ØªØ§Ø­</span>
</h3>
<div class="device-info">
<p>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ: <span class="timer">00:00:00</span></p>
<p>Ø§Ù„ØªÙƒÙ„ÙØ©: <span class="cost">0.00</span> Ø¬Ù†ÙŠÙ‡</p>
</div>
<div class="device-actions">
<button class="control-btn start-btn">Ø¨Ø¯Ø¡</button> <button class="control-btn multiplayer-btn" title="ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø²ÙˆØ¬ÙŠ">2P</button>
<button class="control-btn add-product-btn" title="Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬">+</button>
<button class="control-btn stop-btn" disabled="">Ø¥ÙŠÙ‚Ø§Ù</button>
</div>
</div>
<div class="device-box" data-id="ps5-2">
<button class="delete-btn" title="Ø­Ø°Ù">Ã—</button>
<h3>
                        Ø¬Ù‡Ø§Ø² PS5 (2)
                        <span class="status available">Ù…ØªØ§Ø­</span>
</h3>
<div class="device-info">
<p>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ: <span class="timer">00:00:00</span></p>
<p>Ø§Ù„ØªÙƒÙ„ÙØ©: <span class="cost">0.00</span> Ø¬Ù†ÙŠÙ‡</p>
</div>
<div class="device-actions">
<button class="control-btn start-btn">Ø¨Ø¯Ø¡</button> <button class="control-btn multiplayer-btn" title="ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø²ÙˆØ¬ÙŠ">2P</button>
<button class="control-btn add-product-btn" title="Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬">+</button>
<button class="control-btn stop-btn" disabled="">Ø¥ÙŠÙ‚Ø§Ù</button>
</div>
</div>
<div class="device-box" data-id="ps5-3">
<button class="delete-btn" title="Ø­Ø°Ù">Ã—</button>
<h3>
                        Ø¬Ù‡Ø§Ø² PS5 (3)
                        <span class="status available">Ù…ØªØ§Ø­</span>
</h3>
<div class="device-info">
<p>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ: <span class="timer">00:00:00</span></p>
<p>Ø§Ù„ØªÙƒÙ„ÙØ©: <span class="cost">0.00</span> Ø¬Ù†ÙŠÙ‡</p>
</div>
<div class="device-actions">
<button class="control-btn start-btn">Ø¨Ø¯Ø¡</button> <button class="control-btn multiplayer-btn" title="ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø²ÙˆØ¬ÙŠ">2P</button>
<button class="control-btn add-product-btn" title="Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬">+</button>
<button class="control-btn stop-btn" disabled="">Ø¥ÙŠÙ‚Ø§Ù</button>
</div>
</div>
<div class="device-box" data-id="ps5-4">
<button class="delete-btn" title="Ø­Ø°Ù">Ã—</button>
<h3>
                        Ø¬Ù‡Ø§Ø² PS5 (4)
                        <span class="status available">Ù…ØªØ§Ø­</span>
</h3>
<div class="device-info">
<p>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ: <span class="timer">00:00:00</span></p>
<p>Ø§Ù„ØªÙƒÙ„ÙØ©: <span class="cost">0.00</span> Ø¬Ù†ÙŠÙ‡</p>
</div>
<div class="device-actions">
<button class="control-btn start-btn">Ø¨Ø¯Ø¡</button> <button class="control-btn multiplayer-btn" title="ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø²ÙˆØ¬ÙŠ">2P</button>
<button class="control-btn add-product-btn" title="Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬">+</button>
<button class="control-btn stop-btn" disabled="">Ø¥ÙŠÙ‚Ø§Ù</button>
</div>
</div>
<div class="add-new-container">
<button class="add-new-btn" id="add-ps5-btn">+</button>
</div>
</div>
<div class="section-title">
<h2>Ø£Ø¬Ù‡Ø²Ø© Ø¨Ù„Ø§ÙŠØ³ØªÙŠØ´Ù† 4</h2>
</div>
<div class="dashboard" id="ps4-devices">
<div class="device-box" data-id="ps4-1">
<button class="delete-btn" title="Ø­Ø°Ù">Ã—</button>
<h3>
                        Ø¬Ù‡Ø§Ø² PS4 (5)
                        <span class="status available">Ù…ØªØ§Ø­</span>
</h3>
<div class="device-info">
<p>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ: <span class="timer">00:00:00</span></p>
<p>Ø§Ù„ØªÙƒÙ„ÙØ©: <span class="cost">0.00</span> Ø¬Ù†ÙŠÙ‡</p>
</div>
<div class="device-actions">
<button class="control-btn start-btn">Ø¨Ø¯Ø¡</button> <button class="control-btn multiplayer-btn" title="ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø²ÙˆØ¬ÙŠ">2P</button>
<button class="control-btn add-product-btn" title="Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬">+</button>
<button class="control-btn stop-btn" disabled="">Ø¥ÙŠÙ‚Ø§Ù</button>
</div>
</div>
<div class="device-box" data-id="ps4-2">
<button class="delete-btn" title="Ø­Ø°Ù">Ã—</button>
<h3>
                        Ø¬Ù‡Ø§Ø² PS4 (6)
                        <span class="status available">Ù…ØªØ§Ø­</span>
</h3>
<div class="device-info">
<p>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ: <span class="timer">00:00:00</span></p>
<p>Ø§Ù„ØªÙƒÙ„ÙØ©: <span class="cost">0.00</span> Ø¬Ù†ÙŠÙ‡</p>
</div>
<div class="device-actions">
<button class="control-btn start-btn">Ø¨Ø¯Ø¡</button> <button class="control-btn multiplayer-btn" title="ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø²ÙˆØ¬ÙŠ">2P</button>
<button class="control-btn add-product-btn" title="Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬">+</button>
<button class="control-btn stop-btn" disabled="">Ø¥ÙŠÙ‚Ø§Ù</button>
</div>
</div>
<div class="device-box" data-id="ps4-3">
<button class="delete-btn" title="Ø­Ø°Ù">Ã—</button>
<h3>
                        Ø¬Ù‡Ø§Ø² PS4 (7)
                        <span class="status available">Ù…ØªØ§Ø­</span>
</h3>
<div class="device-info">
<p>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ: <span class="timer">00:00:00</span></p>
<p>Ø§Ù„ØªÙƒÙ„ÙØ©: <span class="cost">0.00</span> Ø¬Ù†ÙŠÙ‡</p>
</div>
<div class="device-actions">
<button class="control-btn start-btn">Ø¨Ø¯Ø¡</button> <button class="control-btn multiplayer-btn" title="ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø²ÙˆØ¬ÙŠ">2P</button>
<button class="control-btn add-product-btn" title="Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬">+</button>
<button class="control-btn stop-btn" disabled="">Ø¥ÙŠÙ‚Ø§Ù</button>
</div>
</div>
<div class="device-box" data-id="ps4-4">
<button class="delete-btn" title="Ø­Ø°Ù">Ã—</button>
<h3>
                        Ø¬Ù‡Ø§Ø² PS4 (8)
                        <span class="status available">Ù…ØªØ§Ø­</span>
</h3>
<div class="device-info">
<p>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ: <span class="timer">00:00:00</span></p>
<p>Ø§Ù„ØªÙƒÙ„ÙØ©: <span class="cost">0.00</span> Ø¬Ù†ÙŠÙ‡</p>
</div>
<div class="device-actions">
<button class="control-btn start-btn">Ø¨Ø¯Ø¡</button> <button class="control-btn multiplayer-btn" title="ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø²ÙˆØ¬ÙŠ">2P</button>
<button class="control-btn add-product-btn" title="Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬">+</button>
<button class="control-btn stop-btn" disabled="">Ø¥ÙŠÙ‚Ø§Ù</button>
</div>
</div>
<div class="add-new-container">
<button class="add-new-btn" id="add-ps4-btn">+</button>
</div>
</div>
</div>
    
    

<div class="report-page" id="report-page">
    <h2 class="section-title">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
    <div class="report-container" id="daily-report">
        <div class="report-header">
            <h3>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ - <span id="report-date"></span></h3>
            <div class="report-actions">
             <a id="download-txt" class="report-btn" href="#" download>
    <i>ğŸ’¾</i> ØªÙ†Ø²ÙŠÙ„ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ… (TXT)
</a>

              
            </div>
        </div>
     

        
<table class="report-table" id="unified-report-table">
    <thead>
        <tr>
            <th>Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
            <th>Ø§Ù„ÙˆÙ‚Øª (Ù…Ù† - Ø¥Ù„Ù‰)</th>
            <th>Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th>
            <th>Ø³Ø¹Ø± Ø§Ù„ÙˆÙ‚Øª</th>
            <th>Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th>Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬</th>
            <th>Ø­Ø°Ù</th> <!-- âœ… Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
        </tr>
    </thead>
    <tbody id="report-table-body"></tbody>
</table>
    </div>
</div>

<div class="settings-page" id="settings-page">
<h2 class="section-title">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2>
<div class="settings-container">
<div class="settings-form">

<div class="settings-section">

<h3>Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© (Ù„Ù„Ø³Ø§Ø¹Ø©)</h3>
<div class="devices-settings-wrapper">

  <div class="device-settings right">
    <div class="setting-item">
      <label>Ø³Ø¹Ø± Ø³Ø§Ø¹Ø© PS4:</label>
      <input id="ps4-price" min="0" type="number" value="30"/>
    </div>
    <div class="setting-item">
      <label> Ø³Ø¹Ø±  Ø§Ù„Ø²ÙˆØ¬ÙŠ Ù€ PS4:</label>
      <input id="multiplayer-price-multiplier-ps4" min="1" step="0.1" type="number" value="1.5"/>
    </div>
  </div>

 
  <div class="device-settings left">
    <div class="setting-item">
      <label>Ø³Ø¹Ø± Ø³Ø§Ø¹Ø© PS5:</label>
      <input id="ps5-price" min="0" type="number" value="50"/>
    </div>
    <div class="setting-item">
      <label> Ø³Ø¹Ø± Ø§Ù„Ø²ÙˆØ¬ÙŠ PS5:</label>
      <input id="multiplayer-price-multiplier-ps5" min="1" step="0.1" type="number" value="1.5"/>
    </div>
  </div>
</div>





<div class="settings-section">
<h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</h3>
<div class="setting-item">
<label>Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:</label>
<label class="toggle-switch">
<input id="show-report-on-login" type="checkbox"/>
<span class="slider"></span>
</label>
</div>
<div class="setting-item">
<label>Ø­ÙØ¸ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹:</label>
<label class="toggle-switch">
<input checked="" id="auto-save-reports" type="checkbox"/>
<span class="slider"></span>
</label>
</div>

</div>
    
    <div class="settings-section">
    <h3>Ø§Ø®ØªØ± Ø§Ù„Ø«ÙŠÙ…</h3>
    <div class="theme-buttons" style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button onclick="ThemeSwitcher.switchTo('light')" class="btn" style="flex: 1; min-width: 120px; background-color: #2e4057;">ÙØ§ØªØ­</button>
        <button onclick="ThemeSwitcher.switchTo('dark')" class="btn" style="flex: 1; min-width: 120px; background-color: #121212; color: #e0e0e0;">Ø¯Ø§ÙƒÙ†</button>
        <button onclick="ThemeSwitcher.switchTo('vibrant')" class="btn" style="flex: 1; min-width: 120px; background-color: #ff6b6b; color: white;">Ù…Ø²Ø±ÙƒØ´</button>
    </div>
</div>
    
<button id="save-settings" class="btn small-btn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>


<script>
const dailyReports = {};
let deviceProducts = {};
let sessionRecords = []; 
let productRecords = []; 
    let timerInterval = null;
let seconds = 0;
let isMultiplayer = false;

// ==== ØªØ¹Ø±ÙŠÙ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù€ DOM ==== //
// ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ù‚Ø¨Ù„ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª
const deviceBox = document.querySelector('.device-box');
const timerEl = document.querySelector('.timer');
const costEl = document.querySelector('.cost');
const statusEl = document.querySelector('.status');
const startBtn = document.querySelector('.start-btn');
const stopBtn = document.querySelector('.stop-btn');
const multiplayerBtn = document.querySelector('.multiplayer-btn');



       
        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
           
            if (username === 'admin' && password === 'admin') {
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
                
              loadSettings(); // â† Ø­Ù…Ù‘Ù„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
loadInvoicesFromLocalStorage();



const showReportSetting = localStorage.getItem('showReportOnLogin');
if (showReportSetting === 'true') {
    showPage('report');
}

            } else {
                alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            }
        });
        
        


        document.getElementById('logout-btn').addEventListener('click', function() {
            document.getElementById('login-page').style.display = 'block';
            document.getElementById('app').style.display = 'none';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        });
        
        

        const navLinks = document.querySelectorAll('.nav-link');
        const pages = document.querySelectorAll('[id$="-page"]');
        
        function showPage(pageId) {
            


            navLinks.forEach(link => {
                if (link.getAttribute('data-page') === pageId) {
                    link.classList.add('active');
                } else if (link.id !== 'logout-btn') {
                    link.classList.remove('active');
                }
            });
            
            


            pages.forEach(page => {
                if (page.id === pageId + '-page') {
                    page.classList.add('active-page');
                } else {
                    page.classList.remove('active-page');
                }
            });
            
            


            if (pageId === 'settings') {
                updateDeleteLists();
            }
            
       
            if (pageId === 'report') {
               
            }
        }
        
        navLinks.forEach(link => {
            if (link.id !== 'logout-btn') {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetPage = this.getAttribute('data-page');
                    showPage(targetPage);
                });
            }
        });
        function setupDeleteButtons() {
  const deleteButtons = document.querySelectorAll('.delete-btn');
  deleteButtons.forEach(deleteBtn => {
    deleteBtn.onclick = function () {
      const deviceBox = deleteBtn.closest('.device-box');
      if (deviceBox) deviceBox.remove();
    };
  });
}
  

        let sessionData = [];
        
        function setupDeviceTimers() {
            document.querySelectorAll('.device-box').forEach((deviceBox, index) => {
                const startBtn = deviceBox.querySelector('.start-btn');
                const stopBtn = deviceBox.querySelector('.stop-btn');
            const multiplayerBtn = deviceBox.querySelector('.multiplayer-btn'); 
            let isMultiplayer = false;
                const timerEl = deviceBox.querySelector('.timer');
                const costEl = deviceBox.querySelector('.cost');
                const statusEl = deviceBox.querySelector('.status');
                const deviceId = deviceBox.getAttribute('data-id');
                
                if (!startBtn || !stopBtn || !timerEl || !costEl || !statusEl) return;
                
                let timerInterval;
                let seconds = 0;
                let sessionStartTime;
multiplayerBtn.addEventListener('click', function () {
  if (startBtn.disabled) {
    alert('Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØºÙŠÙŠØ± ÙˆØ¶Ø¹ Ø§Ù„Ù„Ø¹Ø¨ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¬Ù‡Ø§Ø².');
    return;
  }
  isMultiplayer = !isMultiplayer;
  this.classList.toggle('active', isMultiplayer);
  this.title = isMultiplayer ? 'Ø¥Ù„ØºØ§Ø¡ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø²ÙˆØ¬ÙŠ' : 'ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø²ÙˆØ¬ÙŠ';
});

                
                startBtn.addEventListener('click', function() {
                    
 deviceProducts[deviceId] = [];
                    sessionStartTime = new Date();
                    localStorage.setItem('sessionStartTime', sessionStartTime.toISOString()); 
let activeSessions = JSON.parse(localStorage.getItem('activeSessions') || '{}');
activeSessions[deviceId] = {
    startTime: sessionStartTime.toISOString(),
    seconds: 0,
    isMultiplayer: isMultiplayer,
    products: []
};
localStorage.setItem('activeSessions', JSON.stringify(activeSessions));

                    
                   
                    timerInterval = setInterval(function() {
                        seconds++;
                        const hours = Math.floor(seconds / 3600);
                        const minutes = Math.floor((seconds % 3600) / 60);
                        const secs = seconds % 60;
                        
                       
                        timerEl.textContent = 
                            (hours < 10 ? '0' + hours : hours) + ':' +
                            (minutes < 10 ? '0' + minutes : minutes) + ':' +
                            (secs < 10 ? '0' + secs : secs);
                        
                       
                        const isPS5 = deviceBox.querySelector('h3').textContent.includes('PS5');
                        const hourlyRate = isPS5 ? 
                            parseFloat(document.getElementById('ps5-price').value) : 
                            parseFloat(document.getElementById('ps4-price').value);
                        let currentRate = hourlyRate;
                        if (isMultiplayer) {
                            let multiplier = 1.5;
if (isPS5) {
  const ps5Multiplier = document.getElementById('multiplayer-price-multiplier-ps5');
  multiplier = ps5Multiplier ? parseFloat(ps5Multiplier.value) : 1.5;
} else {
  const ps4Multiplier = document.getElementById('multiplayer-price-multiplier-ps4');
  multiplier = ps4Multiplier ? parseFloat(ps4Multiplier.value) : 1.5;
}

                            currentRate *= Math.max(1, multiplier);
                        }
                        const cost = (seconds / 3600) * currentRate;
                        costEl.textContent = cost.toFixed(2);
let activeSessions = JSON.parse(localStorage.getItem('activeSessions') || '{}');
if (activeSessions[deviceId]) {
    activeSessions[deviceId].seconds = seconds;
    localStorage.setItem('activeSessions', JSON.stringify(activeSessions));
}        
                    }, 1000);
                    
                    
                    startBtn.disabled = true;
                    stopBtn.disabled = false;
                    statusEl.textContent = 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…';
                    statusEl.classList.remove('available');
                    statusEl.classList.add('in-use');
                    multiplayerBtn.disabled = true; 
                });
                
          stopBtn.addEventListener('click', function() {
    clearInterval(timerInterval);

    // Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ù…Ù† localStorage
    let activeSessions = JSON.parse(localStorage.getItem('activeSessions') || '{}');
    delete activeSessions[deviceId];
    localStorage.setItem('activeSessions', JSON.stringify(activeSessions));

    const sessionEndTime = new Date();
    const isPS5 = deviceBox.querySelector('h3').textContent.includes('PS5');
    const deviceName = deviceBox.querySelector('h3').textContent.trim().split('\n')[0].trim();
    const hourlyRate = isPS5 ? 
        parseFloat(document.getElementById('ps5-price').value) : 
        parseFloat(document.getElementById('ps4-price').value);
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ
    let timeCost = seconds >= 60 ? parseFloat(costEl.textContent) : 0;
    const productsList = deviceProducts[deviceId] || [];
    const productsTotal = productsList.reduce((sum, product) => sum + product.price, 0);
    const totalCost = timeCost + productsTotal;
    
    // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„ÙØ§ØªÙˆØ±Ø©
    const invoice = {
        id: 'inv-' + Date.now(),
        deviceId: deviceId,
        deviceName: deviceName,
        date: new Date().toISOString(),
        startTime: sessionStartTime,
        endTime: sessionEndTime,
        duration: seconds,
        timeCost: timeCost,
        products: productsList,
        productsTotal: productsTotal,
        totalCost: totalCost,
        isMultiplayer: isMultiplayer
    };
   
    // Ø¹Ø±Ø¶ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
    displayInvoice(invoice);

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ø¤Ù‡Ù„Ø©
    if (seconds > 0 || productsList.length > 0) {
        const sessionRecord = {
            deviceId: deviceId,
            deviceName: deviceBox.querySelector('h3').textContent.split('#')[0].trim(),
               startTime: sessionStartTime.getTime(), 
               endTime: sessionEndTime.getTime(),
            duration: seconds,
            cost: timeCost,
            isMultiplayer: isMultiplayer,
            products: productsList
        };

        sessionRecords.push(sessionRecord);
localStorage.setItem('sessionRecords', JSON.stringify(sessionRecords)); // â¬…ï¸ Ø­ÙØ¸ Ø§Ù„Ø¬Ù„Ø³Ø§Øª

        updateReportTable();

        const dateKey = sessionStartTime.toISOString().split('T')[0];
        if (!dailyReports[dateKey]) dailyReports[dateKey] = [];
        dailyReports[dateKey].push(sessionRecord);

        generateTextReportForDate(dateKey);
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ø§Ù„Ø©
    resetDeviceState();
});



// Ø¯Ø§Ù„Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
function displayInvoice(invoice) {
    let invoiceMessage = `ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¬Ù„Ø³Ø© #${invoice.id.split('-')[1]}\n\n`;
    invoiceMessage += `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(invoice.date).toLocaleString('ar-EG')}\n`;
    invoiceMessage += `Ø§Ù„Ø¬Ù‡Ø§Ø²: ${invoice.deviceName}\n`;
    invoiceMessage += `Ø§Ù„Ù…Ø¯Ø©: ${formatTime(invoice.duration)}\n`;
    invoiceMessage += `Ø³Ø¹Ø± Ø§Ù„ÙˆÙ‚Øª: ${invoice.timeCost.toFixed(2)} Ø¬Ù†ÙŠÙ‡\n\n`;
    
    if (invoice.products.length > 0) {
        invoiceMessage += `Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:\n`;
        invoice.products.forEach(product => {
            invoiceMessage += `- ${product.name}: ${product.price.toFixed(2)} Ø¬Ù†ÙŠÙ‡\n`;
        });
        invoiceMessage += `\nØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${invoice.productsTotal.toFixed(2)} Ø¬Ù†ÙŠÙ‡\n`;
    } else {
        invoiceMessage += `Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ù…Ù†ØªØ¬Ø§Øª\n\n`;
    }
    
    invoiceMessage += `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ: ${invoice.totalCost.toFixed(2)} Ø¬Ù†ÙŠÙ‡`;
    
    alert(invoiceMessage);
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²
function resetDeviceState() {
    deviceProducts[deviceId] = [];
    startBtn.disabled = false;
    stopBtn.disabled = true;
    multiplayerBtn.disabled = false;
    statusEl.textContent = 'Ù…ØªØ§Ø­';
    statusEl.classList.remove('in-use');
    statusEl.classList.add('available');
    seconds = 0;
    timerEl.textContent = '00:00:00';
    costEl.textContent = '0.00';
    multiplayerBtn.disabled = false;
    updateReportData();
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
function formatTime(totalSeconds) {
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
}
            });
        }
        
       
        setupDeviceTimers();
        setupDeleteButtons();
        setupAddProductButtons();
         restoreActiveSessions();


        
     document.getElementById('save-settings').addEventListener('click', function () {
    const ps5Price = document.getElementById('ps5-price').value;
    const ps4Price = document.getElementById('ps4-price').value;
    const ps5Multi = document.getElementById('multiplayer-price-multiplier-ps5').value;
    const ps4Multi = document.getElementById('multiplayer-price-multiplier-ps4').value;
    const showReport = document.getElementById('show-report-on-login').checked;
    const autoSave = document.getElementById('auto-save-reports').checked;

    localStorage.setItem('ps5Price', ps5Price);
    localStorage.setItem('ps4Price', ps4Price);
    localStorage.setItem('ps5Multi', ps5Multi);
    localStorage.setItem('ps4Multi', ps4Multi);
    localStorage.setItem('showReportOnLogin', showReport);
    localStorage.setItem('autoSaveReports', autoSave);

    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
});


        
        
        function setupModals() {
           
            const modals = document.querySelectorAll('.modal');
            
           
            const closeButtons = document.querySelectorAll('.close-modal, .modal-btn.cancel');
            
           
            closeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    modal.style.display = 'none';
                });
            });
            
            
            window.addEventListener('click', function(event) {
                modals.forEach(modal => {
                    if (event.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
        }
        
       
        setupModals();
        
  
        
       
document.getElementById('add-ps5-btn').addEventListener('click', function () {
    const ps5Devices = document.querySelectorAll('#ps5-devices .device-box');
    const nextNumber = ps5Devices.length + 1;

    const ps5Container = document.getElementById('ps5-devices');
    const newDevice = document.createElement('div');
    const uniqueId = 'ps5-' + nextNumber;
    newDevice.className = 'device-box';
    newDevice.setAttribute('data-id', uniqueId);
    newDevice.innerHTML = `
        <button class="delete-btn" title="Ø­Ø°Ù">Ã—</button>
        <h3>Ø¬Ù‡Ø§Ø² PS5 #${nextNumber} <span class="status available">Ù…ØªØ§Ø­</span></h3>
        <div class="device-info">
            <p>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ: <span class="timer">00:00:00</span></p>
            <p>Ø§Ù„ØªÙƒÙ„ÙØ©: <span class="cost">0.00</span> Ø¬Ù†ÙŠÙ‡</p>
        </div>
        <div class="device-actions">
            <button class="control-btn start-btn">Ø¨Ø¯Ø¡</button>
            <button class="control-btn multiplayer-btn" title="ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø²ÙˆØ¬ÙŠ">2P</button>
            <button class="control-btn add-product-btn" title="Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬">+</button>
            <button class="control-btn stop-btn" disabled>Ø¥ÙŠÙ‚Ø§Ù</button>
        </div>
    `;

    const addBtnContainer = document.querySelector('#ps5-devices .add-new-container');
    ps5Container.insertBefore(newDevice, addBtnContainer);

   
    setupDeviceTimers();
    setupDeleteButtons();
    setupAddProductButtons(); 
     restoreActiveSessions();

});




document.getElementById('add-ps4-btn').addEventListener('click', function () {
    const ps4Devices = document.querySelectorAll('#ps4-devices .device-box');
    const nextNumber = ps4Devices.length + 1;

    const ps4Container = document.getElementById('ps4-devices');
    const newDevice = document.createElement('div');
    const uniqueId = 'ps4-' + nextNumber;
    newDevice.className = 'device-box';
    newDevice.setAttribute('data-id', uniqueId);
    newDevice.innerHTML = `
        <button class="delete-btn" title="Ø­Ø°Ù">Ã—</button>
        <h3>Ø¬Ù‡Ø§Ø² PS4 #${nextNumber} <span class="status available">Ù…ØªØ§Ø­</span></h3>
        <div class="device-info">
            <p>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ: <span class="timer">00:00:00</span></p>
            <p>Ø§Ù„ØªÙƒÙ„ÙØ©: <span class="cost">0.00</span> Ø¬Ù†ÙŠÙ‡</p>
        </div>
        <div class="device-actions">
            <button class="control-btn start-btn">Ø¨Ø¯Ø¡</button>
            <button class="control-btn multiplayer-btn" title="ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø²ÙˆØ¬ÙŠ">2P</button>
            <button class="control-btn add-product-btn" title="Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬">+</button>
            <button class="control-btn stop-btn" disabled>Ø¥ÙŠÙ‚Ø§Ù</button>
        </div>
    `;

    const addBtnContainer = document.querySelector('#ps4-devices .add-new-container');
    ps4Container.insertBefore(newDevice, addBtnContainer);

   
    setupDeviceTimers();
    setupDeleteButtons();
    setupAddProductButtons();
     restoreActiveSessions();
  
});



        
       
        function generateUniqueId(prefix) {
            return prefix + '-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
        }
        
               
   document.getElementById('confirm-add-ps5').addEventListener('click', function() {
            const deviceNumber = document.getElementById('new-ps5-number').value;
            
         if (!deviceNumber) {
               alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²');
                return;
            }
            
            
            const ps5Container = document.getElementById('ps5-devices');
            const newPS5Device = document.createElement('div');
          const uniqueId = generateUniqueId('ps5');
           newPS5Device.className = 'device-box';
           newPS5Device.setAttribute('data-id', uniqueId);
            newPS5Device.innerHTML = `
  <button class="delete-btn" title="Ø­Ø°Ù">Ã—</button>
 <h3>
    Ø¬Ù‡Ø§Ø² PS5 #${deviceNumber}
    <span class="status available">Ù…ØªØ§Ø­</span>
  </h3>
 <div class="device-info">
      <p>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ: <span class="timer">00:00:00</span></p>
     <p>Ø§Ù„ØªÙƒÙ„ÙØ©: <span class="cost">0.00</span> Ø¬Ù†ÙŠÙ‡</p>
  </div>
  <div class="device-actions">
      <button class="control-btn start-btn">Ø¨Ø¯Ø¡</button>
     <button class="control-btn multiplayer-btn" title="ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø²ÙˆØ¬ÙŠ">2P</button>
      <button class="control-btn add-product-btn" title="Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬">+</button>
      <button class="control-btn stop-btn" disabled>Ø¥ÙŠÙ‚Ø§Ù</button>
  </div>
`;

            
          
            const addBtnContainer = document.querySelector('#ps5-devices .add-new-container');
            ps5Container.insertBefore(newPS5Device, addBtnContainer);
            setupAddProductButtons();           
            setupDeleteButtons();
setupAddProductButtons();
restoreActiveSessions();



            
            
            document.getElementById('add-ps5-modal').style.display = 'none';
            document.getElementById('new-ps5-number').value = '';                       
            setupDeviceTimers();
            setupDeleteButtons();
           setupAddProductButtons();
            restoreActiveSessions();
            updateDeleteLists();
            
            alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø§Ø² PS5 #${deviceNumber} Ø¨Ù†Ø¬Ø§Ø­`);
        });
        
        
        document.getElementById('confirm-add-ps4').addEventListener('click', function() {
            const deviceNumber = document.getElementById('new-ps4-number').value;
            
            if (!deviceNumber) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬Ù‡Ø§Ø²');
                return;
            }
            
        
            
            
            const addBtnContainer = document.querySelector('#ps4-devices .add-new-container');
            ps4Container.insertBefore(newPS4Device, addBtnContainer);
          setupDeviceTimers();
setupDeleteButtons();
setupAddProductButtons();
restoreActiveSessions();


            
            
            document.getElementById('add-ps4-modal').style.display = 'none';
            document.getElementById('new-ps4-number').value = '';         
            setupDeviceTimers();
            setupDeleteButtons();
          setupAddProductButtons();
restoreActiveSessions();

            updateDeleteLists();
            
            alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¬Ù‡Ø§Ø² PS4 #${deviceNumber} Ø¨Ù†Ø¬Ø§Ø­`);
        });
        
        
       document.getElementById('add-device-btn').addEventListener('click', function () {
    const deviceType = document.getElementById('new-device-type').value;

    let nextDeviceNumber = 1;
    const existingDevices = document.querySelectorAll(`#${deviceType.toLowerCase()}-devices .device-box`);
    if (existingDevices.length > 0) {
        const lastDevice = existingDevices[existingDevices.length - 1];
        const title = lastDevice.querySelector('h3').textContent;
        const match = title.match(/#(\d+)/);
        if (match) {
            nextDeviceNumber = parseInt(match[1]) + 1;
        }
    }

    
    if (deviceType === 'PS5') {
        document.getElementById('new-ps5-number').value = nextDeviceNumber;
        document.getElementById('confirm-add-ps5').click();
    } else {
        document.getElementById('new-ps4-number').value = nextDeviceNumber;
        document.getElementById('confirm-add-ps4').click();
    }
});

        


        
       

        
   
        
         
        
function loadSettings() {
    const ps5 = localStorage.getItem('ps5Price');
    const ps4 = localStorage.getItem('ps4Price');
    const ps5Multi = localStorage.getItem('ps5Multi');
    const ps4Multi = localStorage.getItem('ps4Multi');
    const showReport = localStorage.getItem('showReportOnLogin');
    const autoSave = localStorage.getItem('autoSaveReports');

    // âœ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Øª Ù„Ùˆ Ù…ÙÙŠØ´ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©
    document.getElementById('ps5-price').value = ps5 !== null ? ps5 : 25;
    document.getElementById('ps4-price').value = ps4 !== null ? ps4 : 20;
    document.getElementById('multiplayer-price-multiplier-ps5').value = ps5Multi !== null ? ps5Multi : 1.5;
    document.getElementById('multiplayer-price-multiplier-ps4').value = ps4Multi !== null ? ps4Multi : 1.5;
    document.getElementById('show-report-on-login').checked = (showReport === 'true');
    document.getElementById('auto-save-reports').checked = (autoSave !== null ? autoSave === 'true' : true);
}


        loadSettings();

       
        updateReportData();







function setupDeleteButtons() {
  const deleteButtons = document.querySelectorAll('.delete-btn');
  deleteButtons.forEach(deleteBtn => {
    deleteBtn.onclick = function () {
      const deviceBox = deleteBtn.closest('.device-box');
      if (deviceBox) deviceBox.remove();
    };
  });
}





function setupAddProductButtons() {
    document.querySelectorAll('.device-box').forEach(deviceBox => {
        const addProductBtn = deviceBox.querySelector('.add-product-btn');
        const deviceId = deviceBox.getAttribute('data-id');

        if (!addProductBtn) return;

        addProductBtn.onclick = function () {
            const name = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:");
            if (!name) return;

            const priceStr = prompt("Ø£Ø¯Ø®Ù„ Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬:");
            if (!priceStr) return;
            const price = parseFloat(priceStr);
            if (isNaN(price)) {
                alert("Ø§Ù„Ø³Ø¹Ø± ØºÙŠØ± ØµØ§Ù„Ø­");
                return;
            }

            const product = { name, price };

            // ØªØ£ÙƒØ¯ Ø¥Ù† ÙÙŠÙ‡ Ù…ØµÙÙˆÙØ© Ù„Ù„Ø¬Ù‡Ø§Ø² Ø¯Ù‡
            if (!deviceProducts[deviceId]) {
                deviceProducts[deviceId] = [];
            }
            deviceProducts[deviceId].push(product);

            // Ø­Ø¯Ø« session ÙÙŠ localStorage
            let sessions = JSON.parse(localStorage.getItem('activeSessions') || '{}');
            if (!sessions[deviceId]) return;

            if (!sessions[deviceId].products) {
                sessions[deviceId].products = [];
            }
            sessions[deviceId].products.push(product);
            localStorage.setItem('activeSessions', JSON.stringify(sessions));

            alert(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ (${name}) Ø¨Ù€ ${price} Ø¬Ù†ÙŠÙ‡`);
        };
    });
}



function updateReportTable() {
    const tbody = document.getElementById('report-table-body');
    tbody.innerHTML = '';

    const savedRecords = localStorage.getItem('sessionRecords');
    if (savedRecords) {
        sessionRecords = JSON.parse(savedRecords).map(record => ({
            ...record,
            startTime: new Date(record.startTime),
            endTime: new Date(record.endTime)
        }));

        // âœ… ÙÙ„ØªØ±Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª ØºÙŠØ± Ø§Ù„Ù…ÙÙŠØ¯Ø©
        const seen = new Set();
        sessionRecords = sessionRecords.filter(record => {
            const isZero = record.duration === 0 && (record.cost === 0 || !record.cost) && (!record.products || record.products.length === 0);
            const key = `${record.deviceId}-${record.startTime.getTime()}`;
            if (seen.has(key)) return false;
            seen.add(key);
            return !isZero;
        });

        // ğŸ“ ØªØ­Ø¯ÙŠØ« localStorage Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø©
        localStorage.setItem('sessionRecords', JSON.stringify(sessionRecords));
    }

    sessionRecords.forEach(record => {
        const startTime = record.startTime.toLocaleTimeString();
        const endTime = record.endTime.toLocaleTimeString();
        const duration = formatTime(record.duration, record.isMultiplayer);

        const productsList = (record.products || []).map(p =>
            `${p.name} (${p.price.toFixed(2)} Ø¬Ù†ÙŠÙ‡)`
        ).join('ØŒ ') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';

        const productsTotal = (record.products || []).reduce((sum, p) => sum + (p.price || 0), 0);

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${record.deviceName || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</td>
            <td>${startTime} - ${endTime}</td>
            <td>${duration}</td>
            <td>${(record.cost || 0).toFixed(2)} Ø¬Ù†ÙŠÙ‡</td>
            <td>${productsList}</td>
            <td>${productsTotal.toFixed(2)} Ø¬Ù†ÙŠÙ‡</td>
            <td><button class="delete-row-btn" style="color:red;">âŒ</button></td>
        `;

        // âœ… Ø²Ø± Ø§Ù„Ø­Ø°Ù Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ù€ localStorage
        const deleteBtn = row.querySelector('.delete-row-btn');
        deleteBtn.addEventListener('click', () => {
            // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ©
            sessionRecords = sessionRecords.filter(r =>
                !(r.deviceId === record.deviceId &&
                  new Date(r.startTime).getTime() === new Date(record.startTime).getTime())
            );

            // ØªØ­Ø¯ÙŠØ« localStorage
            localStorage.setItem('sessionRecords', JSON.stringify(sessionRecords));

            // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
            row.remove();
        });

        tbody.appendChild(row);
    });
}

setupAddProductButtons();
restoreActiveSessions();


function formatTime(seconds, isMultiplayer) {
    const hours = Math.floor(seconds / 3600);
    const minutes = Math.floor((seconds % 3600) / 60);
    const type = isMultiplayer === true ? 'Ø²ÙˆØ¬ÙŠ' : isMultiplayer === false ? 'ÙØ±Ø¯ÙŠ' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    return `${hours} Ø³Ø§Ø¹Ø© ${minutes} Ø¯Ù‚ÙŠÙ‚Ø© (${type})`;
}
function generateTextReportForDate(dateKey) {
    const sessions = dailyReports[dateKey];
    if (!sessions || sessions.length === 0) return;

    let content = `***************\nğŸ—“ï¸ ${formatArabicDate(dateKey)}\n***************\n\n`;
    let total = 0;

    sessions.forEach(s => {
        const start = new Date(s.startTime).toLocaleTimeString();
        const end = new Date(s.endTime).toLocaleTimeString();
        const hours = Math.floor(s.duration / 3600);
        const minutes = Math.floor((s.duration % 3600) / 60);
        const type = s.isMultiplayer === true ? 'Ø²ÙˆØ¬ÙŠ' : s.isMultiplayer === false ? 'ÙØ±Ø¯ÙŠ' : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
        const products = s.products.map(p => `${p.name} (${p.price.toFixed(2)} Ø¬Ù†ÙŠÙ‡)`).join('ØŒ ') || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
        const productTotal = s.products.reduce((sum, p) => sum + p.price, 0);
        const sessionTotal = s.cost + productTotal;
        total += sessionTotal;

        content += `Ø§Ù„Ø¬Ù‡Ø§Ø²: ${s.deviceName}\n`;
        content += `Ø§Ù„ÙˆÙ‚Øª: ${start} - ${end}\n`;
        content += `Ø§Ù„Ù…Ø¯Ø©: ${hours} Ø³Ø§Ø¹Ø© ${minutes} Ø¯Ù‚ÙŠÙ‚Ø© (${type})\n`;
        content += `Ø³Ø¹Ø± Ø§Ù„ÙˆÙ‚Øª: ${s.cost.toFixed(2)} Ø¬Ù†ÙŠÙ‡\n`;
        content += `Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${products}\n`;
        content += `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${sessionTotal.toFixed(2)} Ø¬Ù†ÙŠÙ‡\n\n`;
    });

    content += `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª: ${total.toFixed(2)} Ø¬Ù†ÙŠÙ‡`;

    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const link = document.getElementById('download-txt');
    link.href = url;
    link.download = `report-${dateKey}.txt`;
}
function formatArabicDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString('ar-EG', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    
    
}
// ------ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù…ÙØ¹Ø¯Ù‘Ù„Ø© Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¬Ù„Ø³Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø© ------ //
function restoreActiveSessions() {
    const activeSessions = JSON.parse(localStorage.getItem('activeSessions') || '{}');
    
    document.querySelectorAll('.device-box').forEach(deviceBox => {
        const deviceId = deviceBox.getAttribute('data-id');
        const session = activeSessions[deviceId];
        
        if (!session) return;

        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        let seconds = session.seconds || 0;
        let isMultiplayer = session.isMultiplayer || false;
        const sessionStartTime = new Date(session.startTime);
        
        // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²
        deviceProducts[deviceId] = session.products || [];
        
        // Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const startBtn = deviceBox.querySelector('.start-btn');
        const stopBtn = deviceBox.querySelector('.stop-btn');
        const timerEl = deviceBox.querySelector('.timer');
        const costEl = deviceBox.querySelector('.cost');
        const statusEl = deviceBox.querySelector('.status');
        const multiplayerBtn = deviceBox.querySelector('.multiplayer-btn');

        // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        startBtn.disabled = true;
        stopBtn.disabled = false;
        multiplayerBtn.disabled = true;
        statusEl.textContent = 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…';
        statusEl.classList.replace('available', 'in-use');
        
        if (isMultiplayer) {
            multiplayerBtn.classList.add('active');
            multiplayerBtn.title = 'Ø¥Ù„ØºØ§Ø¡ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø²ÙˆØ¬ÙŠ';
        }

        // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© (Ø§Ù„ÙˆÙ‚Øª + Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª)
        const isPS5 = deviceBox.querySelector('h3').textContent.includes('PS5');
        const basePrice = isPS5 ? 
            parseFloat(document.getElementById('ps5-price').value) : 
            parseFloat(document.getElementById('ps4-price').value);
        const multiplier = isPS5 ?
            parseFloat(document.getElementById('multiplayer-price-multiplier-ps5').value) :
            parseFloat(document.getElementById('multiplayer-price-multiplier-ps4').value);
        
        const timeCost = (seconds / 3600) * (isMultiplayer ? basePrice * multiplier : basePrice);
        const productsCost = deviceProducts[deviceId].reduce((sum, product) => sum + (product.price || 0), 0);
        const totalCost = timeCost + productsCost;

        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const hours = Math.floor(seconds / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const secs = seconds % 60;
        timerEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        costEl.textContent = timeCost.toFixed(2);


        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª Ù…Ù† Ø¬Ø¯ÙŠØ¯
           // ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª Ù…Ù† Ø¬Ø¯ÙŠØ¯ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
        let lastUpdateTime = Date.now(); // â¬…ï¸ Ø¥Ø¶Ø§ÙØ©: Ø­ÙØ¸ ÙˆÙ‚Øª Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«
        let timerInterval = setInterval(() => {
            const now = Date.now();
            const elapsed = now - lastUpdateTime; // â¬…ï¸ Ø¥Ø¶Ø§ÙØ©: Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
            const elapsedSeconds = Math.floor(elapsed / 1000); // â¬…ï¸ Ø¥Ø¶Ø§ÙØ©: ØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ø«ÙˆØ§Ù†ÙŠ

            if (elapsedSeconds > 0) { // â¬…ï¸ Ø¥Ø¶Ø§ÙØ©: ØªØ­Ø¯ÙŠØ« ÙÙ‚Ø· Ø¥Ø°Ø§ Ù…Ø±Ù‘Øª Ø«Ø§Ù†ÙŠØ© Ø£Ùˆ Ø£ÙƒØ«Ø±
                seconds += elapsedSeconds;
                lastUpdateTime = now; // â¬…ï¸ Ø¥Ø¶Ø§ÙØ©: ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«

                // ØªØ­Ø¯ÙŠØ« localStorage
                const updatedSessions = JSON.parse(localStorage.getItem('activeSessions') || '{}');
                if (updatedSessions[deviceId]) {
                    updatedSessions[deviceId].seconds = seconds;
                    localStorage.setItem('activeSessions', JSON.stringify(updatedSessions));
                }
            }

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (ÙŠØ­Ø¯Ø« Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ù„ÙŠØ¹Ø·ÙŠ Ø¥Ø­Ø³Ø§Ø³Ø§Ù‹ Ø¨Ø§Ù„Ø³Ù„Ø§Ø³Ø©)
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            timerEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙƒÙ„ÙØ©
            const updatedTimeCost = (seconds / 3600) * (isMultiplayer ? basePrice * multiplier : basePrice);
            const updatedTotalCost = updatedTimeCost + productsCost;
            costEl.textContent = updatedTotalCost.toFixed(2);

        }, 1000);
        
        



        // Ø±Ø¨Ø· Ø­Ø¯Ø« Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù
        const handleStop = () => {
            clearInterval(timerInterval);
            
            // Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù† localStorage
            const updatedSessions = JSON.parse(localStorage.getItem('activeSessions') || '{}');
            delete updatedSessions[deviceId];
            localStorage.setItem('activeSessions', JSON.stringify(updatedSessions));
            
            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙŠ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
            const sessionEndTime = new Date();
            const finalTimeCost = (seconds / 3600) * (isMultiplayer ? basePrice * multiplier : basePrice);
            const finalProductsCost = deviceProducts[deviceId].reduce((sum, product) => sum + (product.price || 0), 0);
            const finalTotalCost = finalTimeCost + finalProductsCost;
            const finalDuration = seconds; // Ø¥ØµÙ„Ø§Ø­: ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±
            
            // Ø¥ØµÙ„Ø§Ø­: Ø¨Ù†Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
            const sessionRecord = {
                deviceId: deviceId,
                deviceName: deviceBox.querySelector('h3').textContent,
                startTime: sessionStartTime,
                endTime: sessionEndTime,
                duration: finalDuration,
                cost: finalTotalCost,
                isMultiplayer: isMultiplayer,
                products: deviceProducts[deviceId]
            };

            // âœ… Ø£Ø¶Ù Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØµØ§Ù„Ø­Ø©
            const sessionKey = `${sessionRecord.deviceId}-${sessionRecord.startTime}`;
            const sessionRecords = JSON.parse(localStorage.getItem('sessionRecords') || '[]');
            const isDuplicate = sessionRecords.some(record => 
                `${record.deviceId}-${record.startTime}` === sessionKey
            );
            const isZeroSession = sessionRecord.duration === 0 && 
                                 sessionRecord.cost === 0 && 
                                 sessionRecord.products.length === 0;

            if (!isDuplicate && !isZeroSession) {
                sessionRecords.push(sessionRecord);
                localStorage.setItem('sessionRecords', JSON.stringify(sessionRecords));

                const dateKey = sessionStartTime.toISOString().split('T')[0];
                const dailyReports = JSON.parse(localStorage.getItem('dailyReports') || '{}');
                if (!dailyReports[dateKey]) dailyReports[dateKey] = [];
                dailyReports[dateKey].push(sessionRecord);
                localStorage.setItem('dailyReports', JSON.stringify(dailyReports));

                generateTextReportForDate(dateKey);

                // âœ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ§ØªÙˆØ±Ø©
                const invoice = {
                    id: 'inv-' + Date.now(),
                    ...sessionRecord
                };

                let invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
                invoices.push(invoice);
                localStorage.setItem('invoices', JSON.stringify(invoices));

                updateReportTable();

                alert(`ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø¬Ù„Ø³Ø©:\nØ§Ù„ÙˆÙ‚Øª: ${finalTimeCost.toFixed(2)} Ø¬Ù†ÙŠÙ‡\nØ§Ù„Ù…Ù†ØªØ¬Ø§Øª: ${finalProductsCost.toFixed(2)} Ø¬Ù†ÙŠÙ‡\nØ§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${finalTotalCost.toFixed(2)} Ø¬Ù†ÙŠÙ‡`);
            }

            // âœ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ù‡Ø§Ø²
            startBtn.disabled = false;
            stopBtn.disabled = true;
            multiplayerBtn.disabled = false;
            statusEl.textContent = 'Ù…ØªØ§Ø­';
            statusEl.classList.replace('in-use', 'available');
            timerEl.textContent = '00:00:00';
            costEl.textContent = '0.00';
            deviceProducts[deviceId] = [];
        };

        // Ø¥ØµÙ„Ø§Ø­: Ø±Ø¨Ø· Ø§Ù„Ø­Ø¯Ø« Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­
        stopBtn.addEventListener('click', handleStop);
    }); // Ø¥ØµÙ„Ø§Ø­: Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚ÙˆØ³ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯ Ù‡Ù†Ø§
}

// ------ Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ÙÙŠ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ------ //
document.addEventListener('DOMContentLoaded', () => {
    restoreActiveSessions();
    setupDeviceTimers();
    loadReportAfterReload();
    
    
     // âœ… ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù‡Ù†Ø§
    const lastSavedTime = localStorage.getItem('sessionStartTime');
    if (lastSavedTime) {
        let elapsedTime = Math.floor((new Date() - new Date(lastSavedTime)) / 1000);
        console.log("Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ Ù…Ù†Ø° Ø¢Ø®Ø± Ø¬Ù„Ø³Ø©:", elapsedTime);
        // ØªÙ‚Ø¯Ø± ØªØ³ØªØ¯Ø¹ÙŠ Ù‡Ù†Ø§ Ø¯Ø§Ù„Ø© ØªØ­Ø¯Ø« Ø§Ù„Ù€ timer Ø­Ø³Ø¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
    }
});
    
    
    
    

function saveDevicesToLocalStorage() {
    const allDevices = [];
    document.querySelectorAll('.device-box').forEach(box => {
        const deviceId = box.getAttribute('data-id');
        const title = box.querySelector('h3').textContent.trim();
        const isPS5 = title.includes('PS5');

        allDevices.push({
            id: deviceId,
            name: title,
            type: isPS5 ? 'ps5' : 'ps4'
        });
    });

    localStorage.setItem('savedDevices', JSON.stringify(allDevices));
}
function restoreDevicesFromLocalStorage() {
    const savedDevices = JSON.parse(localStorage.getItem('savedDevices') || '[]');
    savedDevices.forEach(device => {
        const container = document.getElementById(`${device.type}-devices`);
        const newDevice = document.createElement('div');
        newDevice.className = 'device-box';
        newDevice.setAttribute('data-id', device.id);

        const label = device.name || `Ø¬Ù‡Ø§Ø² ${device.type.toUpperCase()} Ø¬Ø¯ÙŠØ¯`;

        newDevice.innerHTML = `
            <button class="delete-btn" title="Ø­Ø°Ù">Ã—</button>
            <h3>${label} <span class="status available">Ù…ØªØ§Ø­</span></h3>
            <div class="device-info">
                <p>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ: <span class="timer">00:00:00</span></p>
                <p>Ø§Ù„ØªÙƒÙ„ÙØ©: <span class="cost">0.00</span> Ø¬Ù†ÙŠÙ‡</p>
            </div>
            <div class="device-actions">
                <button class="control-btn start-btn">Ø¨Ø¯Ø¡</button>
                <button class="control-btn multiplayer-btn" title="ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ø¹Ø¨ Ø§Ù„Ø²ÙˆØ¬ÙŠ">2P</button>
                <button class="control-btn add-product-btn" title="Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬">+</button>
                <button class="control-btn stop-btn" disabled>Ø¥ÙŠÙ‚Ø§Ù</button>
            </div>
        `;

        const addBtnContainer = container.querySelector('.add-new-container');
        container.insertBefore(newDevice, addBtnContainer);
    });

    setupDeviceTimers();
    setupDeleteButtons();
    setupAddProductButtons();
    restoreActiveSessions();
}
function loadInvoicesFromLocalStorage() {
    try {
        const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
        invoices.forEach(invoice => {
            // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ© ÙƒÙƒØ§Ø¦Ù†Ø§Øª Date
            invoice.startTime = new Date(invoice.startTime);
            invoice.endTime = new Date(invoice.endTime);

            // Ø£Ø¹Ø¯ Ø¨Ù†Ø§Ø¡ Ø³Ø¬Ù„ Ø§Ù„Ø¬Ù„Ø³Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
            const sessionRecord = {
                deviceId: invoice.deviceId,
                deviceName: invoice.deviceName,
                startTime: invoice.startTime,
                endTime: invoice.endTime,
                duration: invoice.duration,
                cost: invoice.cost || invoice.timeCost, // Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒÙ„Ø§ Ø§Ù„Ø­Ù‚Ù„ÙŠÙ† Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªÙˆØ§ÙÙ‚
                isMultiplayer: invoice.isMultiplayer,
                products: invoice.products || [],
                productsTotal: invoice.productsTotal || 0,
                totalCost: invoice.totalCost || 0
            };

            sessionRecords.push(sessionRecord);

            // ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù€ dailyReports
            const dateKey = invoice.startTime.toISOString().split('T')[0];
            if (!dailyReports[dateKey]) dailyReports[dateKey] = [];
            dailyReports[dateKey].push(sessionRecord);
        });

        updateReportTable(); // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
    } catch (error) {
        console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ù…Ù† localStorage:', error);
    }
}
document.addEventListener('DOMContentLoaded', () => {
    restoreActiveSessions();
    setupDeviceTimers();
});

    
    
    
    
    
    
    
    
    
function handleStop(deviceBox, deviceId) {
    // ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù…Ø¤Ù‚Øª Ù†Ø´Ø·
    if (!timerInterval) return;

    // Ø£ÙˆÙ‚Ù Ø§Ù„Ù…Ø¤Ù‚Øª ÙˆØ­Ø°ÙÙ‡
    clearInterval(timerInterval);
    timerInterval = null;

    // Ø§Ø­Ø³Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
    const isPS5 = deviceBox.querySelector('h3').textContent.includes('PS5');
    const basePrice = isPS5 ? 
        parseFloat(document.getElementById('ps5-price').value) : 
        parseFloat(document.getElementById('ps4-price').value);
    const multiplier = isPS5 ?
        parseFloat(document.getElementById('multiplayer-price-multiplier-ps5').value) :
        parseFloat(document.getElementById('multiplayer-price-multiplier-ps4').value);
    const totalCost = (seconds / 3600) * (isMultiplayer ? basePrice * multiplier : basePrice);

    // Ø¹Ø±Ø¶ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
    if (!deviceBox.dataset.invoiceShown) {
        alert(`Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${totalCost.toFixed(2)} Ø¬Ù†ÙŠÙ‡`);
        deviceBox.dataset.invoiceShown = 'true'; // ÙˆØ¶Ø¹ Ø¹Ù„Ø§Ù…Ø© Ù„ØªØ¬Ù†Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¹Ø±Ø¶
    }

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const stopBtn = deviceBox.querySelector('.stop-btn');
    const startBtn = deviceBox.querySelector('.start-btn');
    const multiplayerBtn = deviceBox.querySelector('.multiplayer-btn');
    const statusEl = deviceBox.querySelector('.status');

    stopBtn.disabled = true;
    startBtn.disabled = false;
    multiplayerBtn.disabled = false;
    statusEl.textContent = 'Ù…ØªØ§Ø­';
    statusEl.classList.replace('in-use', 'available');

    // Ø­Ø°Ù Ø§Ù„Ø¬Ù„Ø³Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
    const activeSessions = JSON.parse(localStorage.getItem('activeSessions') || {});
    delete activeSessions[deviceId];
    localStorage.setItem('activeSessions', JSON.stringify(activeSessions));

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    seconds = 0;
    deviceBox.querySelector('.timer').textContent = '00:00:00';
    deviceBox.querySelector('.cost').textContent = '0.00';
}
    
    
    
    
    function loadReportAfterReload() {
    // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ù…Ù† localStorage
    const savedReports = localStorage.getItem('sessionRecords');
    
    if (savedReports) {
        // 2. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© JavaScript
        const parsedReports = JSON.parse(savedReports);
        
        // 3. ØªØ­Ø¯ÙŠØ« Ù…ØªØºÙŠØ± sessionRecords Ø§Ù„Ø¹Ø§Ù…
        sessionRecords = parsedReports.map(report => ({
            ...report,
            startTime: new Date(report.startTime), // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
            endTime: new Date(report.endTime)      // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ®
        }));
        
        // 4. ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        updateReportTable();
    }
}
    
    
    
// Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³ÙƒØ±Ø¨Øª 
document.addEventListener('DOMContentLoaded', function() {
    let sessionRecords = JSON.parse(localStorage.getItem('sessionRecords')) || [];
    let dailyReports = JSON.parse(localStorage.getItem('dailyReports')) || {};
    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø¥Ø°Ø§ Ù„Ù… ØªÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø©
    if (!window.sessionRecords) {
        window.sessionRecords = JSON.parse(localStorage.getItem('sessionRecords')) || [];
    }
    if (!window.dailyReports) {
        window.dailyReports = JSON.parse(localStorage.getItem('dailyReports')) || {};
    }

    // ØªØ¹Ø±ÙŠÙ Ø¹Ù†Ø§ØµØ± Ø­Ø°Ù Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
    const deleteAllBtn = document.getElementById('delete-all-reports-btn');
    const confirmDeleteModal = document.getElementById('confirm-delete-modal');
    const cancelDeleteBtn = document.getElementById('cancel-delete');
    const confirmDeleteBtn = document.getElementById('confirm-delete');
    
    if (deleteAllBtn && confirmDeleteModal && cancelDeleteBtn && confirmDeleteBtn) {
        deleteAllBtn.addEventListener('click', function(e) {
            e.preventDefault();
            confirmDeleteModal.style.display = 'flex';
        });
        
        cancelDeleteBtn.addEventListener('click', function() {
            confirmDeleteModal.style.display = 'none';
        });
        
        confirmDeleteBtn.addEventListener('click', function() {
            // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
            localStorage.removeItem('sessionRecords');
            localStorage.removeItem('dailyReports');
            localStorage.removeItem('invoices');
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
            sessionRecords = [];
            dailyReports = {};
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
            updateReportTable();
            
            // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„
            confirmDeleteModal.style.display = 'none';
            
            alert('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø¨Ù†Ø¬Ø§Ø­!');
        });
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        window.addEventListener('click', function(event) {
            if (event.target === confirmDeleteModal) {
                confirmDeleteModal.style.display = 'none';
            }
        });
    }
});
    
function updateReportData() {
    // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø£ÙƒØ«Ø± Ø£Ù…Ø§Ù†Ø§Ù‹
    let sessionRecords = [];
    try {
        sessionRecords = JSON.parse(localStorage.getItem('sessionRecords')) || [];
    } catch (e) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ù„Ø³Ø§Øª:", e);
        sessionRecords = [];
    }

    // 2. ØªØ­Ø³ÙŠÙ† Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…
    const deviceSessions = {};
    let totalDeviceRevenue = 0;
    sessionRecords.forEach(session => {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        if (!session?.deviceId) return;
        if (!deviceSessions[session.deviceId]) {
            deviceSessions[session.deviceId] = {
                deviceName: session.deviceName || 'Ø¬Ù‡Ø§Ø² ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                totalTime: 0,
                sessionCount: 0,
                revenue: 0
            };
        }
        // Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©
        deviceSessions[session.deviceId].totalTime += Number(session.duration) || 0;
        deviceSessions[session.deviceId].sessionCount++;
        deviceSessions[session.deviceId].revenue += Number(session.cost) || 0;
    });

    // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø¹ ØªØ­Ø³ÙŠÙ†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
    const devicesTable = document.getElementById('devices-report-table')?.querySelector('tbody');
    if (!devicesTable) {
        console.warn("Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!");
        return;
    }
    // ØªÙØ±ÙŠØº Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø£ÙƒØ«Ø± ÙƒÙØ§Ø¡Ø©
    devicesTable.innerHTML = '';
    Object.values(deviceSessions).forEach(device => {
        const totalSeconds = device.totalTime;
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ù…Ø¹ Ø§Ù„ØªØ­Ø³ÙŠÙ†
        const formattedTime = [
            hours.toString().padStart(2, '0'),
            minutes.toString().padStart(2, '0'),
            seconds.toString().padStart(2, '0')
        ].join(':');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${device.deviceName}</td>
            <td>${formattedTime}</td>
            <td>${device.sessionCount}</td>
            <td>${device.revenue.toFixed(2)} Ø¬Ù†ÙŠÙ‡</td>
        `;
        devicesTable.appendChild(row);
        totalDeviceRevenue += device.revenue;
    });

    // 4. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù„Ø®Øµ Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¢Ù…Ù†Ø©
    const summaryItems = document.querySelectorAll('.summary-item');
    if (summaryItems.length > 0) {
        const revenueText = `${totalDeviceRevenue.toFixed(2)} Ø¬Ù†ÙŠÙ‡`;
        if (summaryItems[0]) {
            const span = summaryItems[0].querySelector('span:last-child');
            if (span) span.textContent = revenueText;
        }
        if (summaryItems[3]) {
            const span = summaryItems[3].querySelector('span:last-child');
            if (span) span.textContent = revenueText;
        }
    }
}
    
    // Ø¥Ø¶Ø§ÙØ© Ù‚Ù†Ø§Ø© Ø§ØªØµØ§Ù„ Ù…Ø¹ Service Worker
const channel = new BroadcastChannel ? new BroadcastChannel('timer-channel') : null;

if (channel) {
    channel.addEventListener('message', (event) => {
        if (event.data.type === 'timer-update') {
            const { deviceId, seconds } = event.data;
            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙŠ Ø§Ù„ØµÙØ­Ø© ÙˆØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡ØªÙ‡
            const deviceBox = document.querySelector(`.device-box[data-id="${deviceId}"]`);
            if (deviceBox && deviceBox.querySelector('.status').textContent === 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…') {
                const timerEl = deviceBox.querySelector('.timer');
                const costEl = deviceBox.querySelector('.cost');

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                timerEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

                // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙƒÙ„ÙØ© (Ù‡Ù†Ø§Ø®Ø¯ Ø§Ù„Ø³Ø¹Ø± Ù…Ù† Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª)
                const isPS5 = deviceBox.querySelector('h3').textContent.includes('PS5');
                const basePrice = isPS5 ? 
                    parseFloat(document.getElementById('ps5-price').value) : 
                    parseFloat(document.getElementById('ps4-price').value);
                const multiplier = isPS5 ?
                    parseFloat(document.getElementById('multiplayer-price-multiplier-ps5').value) :
                    parseFloat(document.getElementById('multiplayer-price-multiplier-ps4').value);

                // Ù†Ø­ØªØ§Ø¬ isMultiplayer â€” Ù‡Ù†Ø¬ÙŠØ¨Ù‡ Ù…Ù† localStorage
                const activeSessions = JSON.parse(localStorage.getItem('activeSessions') || '{}');
                const isMultiplayer = activeSessions[deviceId]?.isMultiplayer || false;

                const timeCost = (seconds / 3600) * (isMultiplayer ? basePrice * multiplier : basePrice);
                costEl.textContent = timeCost.toFixed(2);

                // ØªØ­Ø¯ÙŠØ« localStorage
                if (activeSessions[deviceId]) {
                    activeSessions[deviceId].seconds = seconds;
                    localStorage.setItem('activeSessions', JSON.stringify(activeSessions));
                }
            }
        }
    });
}

// Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ø£Ø±Ø³Ù„ Ø¥Ø´Ø§Ø±Ø© Ù„Ù„Ù€ Service Worker
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('start-btn') && !e.target.disabled) {
        // Ø§Ù†ØªØ¸Ø± Ø´ÙˆÙŠØ© Ø¹Ø´Ø§Ù† Ø§Ù„Ø¬Ù„Ø³Ø© ØªØªØ³Ø¬Ù„ ÙÙŠ localStorage
        setTimeout(() => {
            const deviceBox = e.target.closest('.device-box');
            const deviceId = deviceBox.getAttribute('data-id');
            const activeSessions = JSON.parse(localStorage.getItem('activeSessions') || '{}');
            const session = activeSessions[deviceId];

            if (session) {
                // Ø£Ø±Ø³Ù„ Ø£Ù…Ø± "Ø¨Ø¯Ø¡" Ù„Ù„Ù€ Service Worker
                if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage({
                        action: 'start',
                        deviceId,
                        startTime: session.startTime,
                        isMultiplayer: session.isMultiplayer
                    });
                }
            }
        }, 100);
    }
});

// Ø¹Ù†Ø¯ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¬Ù„Ø³Ø©ØŒ Ø£Ø±Ø³Ù„ Ø£Ù…Ø± "Ø¥ÙŠÙ‚Ø§Ù"
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('stop-btn') && !e.target.disabled) {
        const deviceBox = e.target.closest('.device-box');
        const deviceId = deviceBox.getAttribute('data-id');

        if (navigator.serviceWorker && navigator.serviceWorker.controller) {
            navigator.serviceWorker.controller.postMessage({
                action: 'stop',
                deviceId
            });
        }
    }
});
   
    
    
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then(reg => console.log('âœ… Service Worker Ù…Ø³Ø¬Ù„:', reg.scope))
      .catch(err => console.log('âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Service Worker:', err));
  });
}

 </script>
     <script src="register-sw.js"></script>
</body>
</html>
